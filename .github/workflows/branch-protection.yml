# .github/workflows/branch-protection.yml
# This workflow enforces approval requirements for pull requests to main and dev branches

name: Branch Protection & Approval Check

on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  check-approval:
    name: Check Team Approval
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR author is in approval team
        id: check_team
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const team_slug = 'core-approvers'; // Your team name (lowercase, hyphenated)
            const org = context.repo.owner;
            const pr_author = context.payload.pull_request.user.login;
            
            try {
              // Check if PR author is in the approval team
              const { data: membership } = await github.rest.teams.getMembershipForUserInOrg({
                org: org,
                team_slug: team_slug,
                username: pr_author
              });
              
              if (membership.state === 'active') {
                console.log(`✅ PR author ${pr_author} is in the approval team`);
                core.setOutput('is_approver', 'true');
              } else {
                core.setOutput('is_approver', 'false');
              }
            } catch (error) {
              console.log(`❌ PR author ${pr_author} is NOT in the approval team`);
              core.setOutput('is_approver', 'false');
            }

      - name: Check for team approval
  id: check_reviews
  uses: actions/github-script@v7
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    script: |
      const team_slug = 'core-approvers';
      const org = context.repo.owner;

      const pr_number =
        context.issue?.number ||
        context.payload.pull_request?.number;

      if (!pr_number) {
        core.setFailed('❌ Unable to determine PR number');
        return;
      }

      const is_pr_author_approver = '${{ steps.check_team.outputs.is_approver }}' === 'true';

      // Get all reviews for this PR
      const { data: reviews } = await github.rest.pulls.listReviews({
        owner: context.repo.owner,
        repo: context.repo.repo,
        pull_request_number: pr_number
      });

      // Get team members
      const { data: teamMembers } = await github.rest.teams.listMembersInOrg({
        org,
        team_slug
      });

      const approverLogins = teamMembers.map(m => m.login);

      const approvedByTeam = reviews.some(review =>
        review.state === 'APPROVED' &&
        approverLogins.includes(review.user.login) &&
        review.user.login !== context.payload.pull_request.user.login
      );

      if (approvedByTeam) {
        core.setOutput('approved', 'true');
      } else {
        core.setOutput('approved', 'false');
        core.setOutput(
          'message',
          is_pr_author_approver
            ? 'PR author is a core approver but still requires approval from another team member'
            : 'PR requires approval from the core approval team'
        );
      }


      - name: Add comment if approval needed
        if: steps.check_reviews.outputs.approved != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = '${{ steps.check_reviews.outputs.message }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ⚠️ Approval Required\n\n${message}\n\n**Required:** At least 1 approval from @${context.repo.owner}/core-approvers\n\n---\n*This is an automated check to ensure proper code review.*`
            });

      - name: Require approval
        if: steps.check_reviews.outputs.approved != 'true'
        run: |
          echo "❌ This PR requires approval from the core approval team"
          echo "Message: ${{ steps.check_reviews.outputs.message }}"
          exit 1

      - name: Approval check passed
        if: steps.check_reviews.outputs.approved == 'true'
        run: |
          echo "✅ PR has been approved by a core team member"
          echo "This PR can be merged!"