name: Core Team Approval Check

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  core-approval:
    runs-on: ubuntu-latest

    steps:
      - name: Verify core team approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const TEAM_SLUG = 'core-approvers';
            const ORG = context.repo.owner;

            // PR number (guaranteed)
            const prNumber = context.issue.number;
            if (!prNumber) {
              core.setFailed('❌ Not running on a pull request');
              return;
            }

            // Load PR
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const author = pr.user.login;

            // Load team members
            const { data: members } = await github.rest.teams.listMembersInOrg({
              org: ORG,
              team_slug: TEAM_SLUG,
            });

            const approvers = members.map(m => m.login);

            // Load reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: prNumber,
            });

            // Validate approval
            const approved = reviews.some(r =>
              r.state === 'APPROVED' &&
              approvers.includes(r.user.login) &&
              r.user.login !== author
            );

            if (!approved) {
              core.setFailed(
                `❌ Approval required from @${ORG}/${TEAM_SLUG} (self-approval not allowed)`
              );
              return;
            }

            console.log('✅ Core team approval verified');
