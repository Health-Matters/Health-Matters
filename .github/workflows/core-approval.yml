name: Core Team Approval Check

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  core-approval:
    runs-on: ubuntu-latest

    steps:
      - name: Verify core team approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const TEAM_SLUG = 'core-approvers';
            const ORG = context.repo.owner;
            const OWNER = context.repo.owner;
            const REPO = context.repo.repo;
            const PR_NUMBER = context.issue.number;

            if (!PR_NUMBER) {
              core.setFailed('❌ Not running on a pull request');
              return;
            }

            // Load PR
            const { data: pr } = await github.rest.pulls.get({
              owner: OWNER,
              repo: REPO,
              pull_number: PR_NUMBER,
            });

            const author = pr.user.login;

            // Load reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: OWNER,
              repo: REPO,
              pull_request_number: PR_NUMBER,
            });

            // Only valid approvals (no self-approval)
            const approvals = reviews.filter(r =>
              r.state === 'APPROVED' &&
              r.user &&
              r.user.login !== author
            );

            if (approvals.length === 0) {
              core.setFailed(`❌ Approval required from @${ORG}/${TEAM_SLUG}`);
              return;
            }

            // Check if ANY approving reviewer is in the team
            for (const review of approvals) {
              const reviewer = review.user.login;

              try {
                const { data: membership } =
                  await github.rest.teams.getMembershipForUserInOrg({
                    org: ORG,
                    team_slug: TEAM_SLUG,
                    username: reviewer,
                  });

                if (membership.state === 'active') {
                  console.log(`✅ Approved by core team member: ${reviewer}`);
                  return;
                }
              } catch {
                // reviewer is not in the team → ignore
              }
            }

            core.setFailed(
              `❌ PR must be approved by a member of @${ORG}/${TEAM_SLUG} (self-approval not allowed)`
            );
