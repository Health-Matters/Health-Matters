name: Core Team Approval Check

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, ready_for_review, submitted]

permissions:
  contents: read
  pull-requests: read

jobs:
  core-approval:
    runs-on: ubuntu-latest
    steps:
      - name: Verify core team approval
        uses: actions/github-script@v7
        with:
          # REQUIRED: Use a PAT with 'read:org' scope. 
          # Default GITHUB_TOKEN cannot see team members.
          github-token: ${{ secrets.ORG_READ_TOKEN }}
          script: |
            const TEAM_SLUG = 'core-approvers';
            const ORG = context.repo.owner;
            const prAuthor = context.payload.pull_request.user.login;

            try {
              // 1. Get all members of the core team (handles pagination)
              const teamMembers = await github.paginate(github.rest.teams.listMembersInOrg, {
                org: ORG,
                team_slug: TEAM_SLUG,
              });
              
              const coreLogins = teamMembers.map(m => m.login.toLowerCase());
              console.log(`Core Team Members: ${coreLogins.join(', ')}`);

              // 2. Get all reviews for this PR
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              // 3. Check for a valid approval
              // Logic: Must be 'APPROVED', must be in the team, and cannot be the PR author
              const isApproved = reviews.some(review => {
                const reviewer = review.user.login.toLowerCase();
                return review.state === 'APPROVED' && 
                       coreLogins.includes(reviewer) && 
                       reviewer !== prAuthor.toLowerCase();
              });

              if (isApproved) {
                console.log('✅ Approved by a core team member.');
              } else {
                core.setFailed(`❌ This PR requires approval from a member of the @${ORG}/${TEAM_SLUG} team (excluding the author).`);
              }
            } catch (error) {
              console.log(error);
              core.setFailed(`Workflow failed: ${error.message}. Check if ORG_READ_TOKEN is valid and has 'read:org' scope.`);
            }